<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AI (v28.0 Stable)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- html2pdf for auto PDF save -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- [ë””ìì¸ ì‹œìŠ¤í…œ] --- */
        :root {
            --primary-dark: #1a237e; --primary-main: #283593; --accent-color: #3949ab;
            --bg-color: #f5f5f5; --card-bg: #ffffff; 
            --text-primary: #212121; --text-secondary: #546e7a;
            --border-color: #cfd8dc; --expert-gold: #f57f17;
            
            --moisture-blue: #0277bd; --sonic-purple: #7b1fa2; --uv-violet: #311b92;
            --thermal-orange: #d84315; --warning-red: #c62828;
            
            --shadow-card: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --container-max-width: 600px;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-color); color: var(--text-primary);
            margin: 0; padding: 0; line-height: 1.6; display: flex; justify-content: center;
            min-height: 100vh; padding-bottom: 80px;
        }

        .mobile-container {
            width: 100%; max-width: var(--container-max-width); background-color: var(--card-bg);
            box-shadow: var(--shadow-card); 
            min-height: 100vh; margin: 0; position: relative;
        }

        /* ì»´íŒ©íŠ¸ í—¤ë” */
        .main-header {
            background: linear-gradient(145deg, var(--primary-dark), var(--primary-main)); color: white;
            padding: 12px 15px 8px 15px; 
            display: flex; flex-direction: column; align-items: center; 
            box-shadow: 0 2px 8px rgba(40, 53, 147, 0.2);
            position: sticky; top: 0; z-index: 100;
        }
        .main-header h1 {
            margin: 0; font-size: 1.15rem; font-weight: 800; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2); width: 100%;
            line-height: 1.2;
        }
        .main-header h1 i { color: #81d4fa; font-size: 1.1em; }
        
        .version-badge {
            align-self: flex-end; 
            background: rgba(255,255,255,0.15); color: #e3f2fd;
            padding: 1px 8px; border-radius: 8px; font-size: 0.6rem; font-weight: 500;
            border: 1px solid rgba(255,255,255,0.2); white-space: nowrap;
            margin-top: 2px; 
        }
        .version-badge.dev-active { background: #6200ea; border-color: #b388ff; box-shadow: 0 0 10px #6200ea; color: #fff;}

        .content { padding: 10px; padding-top: 15px; }
        .section { margin-bottom: 20px; background: #fff; border-radius: 12px; border: 1px solid #eee; }
        
        .section-title {
            font-weight: 800; color: var(--primary-dark); margin-bottom: 10px; margin-top: 5px;
            display: flex; align-items: center; font-size: 1.0rem;
            border-left: 4px solid var(--expert-gold); padding-left: 10px;
        }
        .section-title i { margin-right: 8px; color: var(--text-secondary); opacity: 0.8; }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .input-group { margin-bottom: 6px; }
        .input-label { display: block; font-weight: 700; margin-bottom: 3px; color: var(--text-secondary); font-size: 0.8rem; text-align: center; }
        
        input[type="text"], input[type="number"], textarea, select {
            width: 100%; padding: 8px; 
            border: 1px solid var(--border-color); border-radius: 6px;
            background-color: #fcfcfc; font-size: 0.9rem; box-sizing: border-box; 
            color: var(--text-primary); 
            font-weight: 700; 
            transition: border 0.2s;
            text-align: center !important; 
            text-align-last: center !important; 
        }

        ::placeholder {
            color: #b0bec5 !important;
            font-weight: 300 !important;
            opacity: 1;
        }
        
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 10px auto;
        }
        
        input:focus, textarea:focus, select:focus { border-color: var(--primary-main); outline: none; background: #fff; }
        textarea { resize: none; height: 70px; text-align: left !important; }
        
        /* ê·¸ë¦¬ë“œ ì¡°ì • */
        .info-grid-row { 
            display: grid; 
            grid-template-columns: 0.7fr 1fr 1.2fr 1.5fr; 
            gap: 5px; align-items: end; margin-bottom: 8px; 
        }
        .info-triple-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr 0.8fr; 
            gap: 5px; align-items: end; margin-bottom: 8px; 
        }
        .info-triple-row select {
            padding: 8px 20px 8px 8px;
            font-size: 0.85rem;
            letter-spacing: -0.5px;
        }

        .tdr-input { background-color: #fff3e0 !important; border: 1px solid #ffb74d !important; color: #e65100 !important; font-weight: 800; }
        .vap-input { background-color: #e1f5fe !important; border: 1px solid #4fc3f7 !important; color: #01579b !important; font-weight: 800; }

        /* ìŠ¤ìº” ì¤‘ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes scan-glow {
            0% { box-shadow: 0 0 5px rgba(33, 150, 243, 0); border-color: #cfd8dc; }
            50% { box-shadow: 0 0 15px rgba(33, 150, 243, 0.5); border-color: #2196f3; background-color: #e3f2fd; }
            100% { box-shadow: 0 0 5px rgba(33, 150, 243, 0); border-color: #cfd8dc; }
        }
        .scanning { animation: scan-glow 1.5s infinite; transition: all 0.3s; }

        /* ì‚¬ì§„ ì—…ë¡œë“œ UI */
        .photo-stack { display: flex; flex-direction: column; gap: 15px; }
        .upload-wrapper { 
            border: 1px dashed #b0bec5; padding: 10px; border-radius: 10px; 
            background: #fafafa; position: relative; transition: all 0.2s;
        }
        .upload-wrapper.filled { border-style: solid; border-color: var(--primary-main); background: #e8eaf6; }
        
        .upload-box {
            border: 2px dashed #cfd8dc; background-color: #fff; border-radius: 8px; width: 100%; aspect-ratio: 4 / 2.5; 
            text-align: center; color: #90a4ae; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; overflow: hidden; transition: all 0.2s; margin-bottom: 8px;
        }
        .upload-box:hover { border-color: var(--primary-main); background: #f5f5f5; }
        .upload-icon { font-size: 1.8rem; margin-bottom: 5px; opacity: 0.6; }
        .preview-img { width: 100%; height: 100%; object-fit: contain; display: none; background: #000; }
        .file-input { display: none; }
        
        .add-photo-btn {
            display: inline-flex; 
            align-items: center; justify-content: center; gap: 6px;
            padding: 8px 15px; 
            background: linear-gradient(145deg, #42a5f5, #1565c0); 
            color: white; 
            border: none; border-radius: 8px; 
            font-size: 0.8rem; font-weight: 700; 
            cursor: pointer; 
            box-shadow: 0 3px 0 #0d47a1, 0 5px 5px rgba(0,0,0,0.15);
            transition: all 0.1s;
            margin-top: 5px;
        }
        .add-photo-btn:active { transform: translateY(3px); box-shadow: 0 0 0 #0d47a1; }
        .add-photo-btn i { font-size: 0.9rem; }

        /* ê²°ê³¼ ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
        #result-area { margin-top: 30px; padding: 20px; background-color: #fff; border-radius: 15px; border: 2px solid var(--primary-main); display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: visible; }
        #analysis-content { overflow: visible; word-break: break-word; }
        #analysis-content h1, #analysis-content h2, #analysis-content h3 { color: var(--primary-dark); margin-top: 20px; }
        #analysis-content p { margin-bottom: 12px; }
        .report-badge {
            background-color: #e8eaf6; color: var(--primary-dark); padding: 8px 12px; border-radius: 8px;
            font-size: 0.75rem; font-weight: 700; margin-bottom: 20px; border-left: 4px solid var(--primary-main);
            line-height: 1.4;
        }
        
        .report-gallery {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
            padding-bottom: 20px; border-bottom: 1px dashed #ddd;
        }
        .report-img-item { 
            border-radius: 8px; overflow: hidden; border: 1px solid #eee; 
            aspect-ratio: 4 / 3; 
            background: #000;    
            display: flex; flex-direction: column;
        }
        .report-img-item img { 
            width: 100%; height: 100%; 
            object-fit: contain; 
            display: block; 
        }
        .report-img-caption { 
            font-size: 0.7rem; padding: 4px; text-align: center; 
            background: #f5f5f5; color: #555; font-weight: bold; width: 100%;
            margin-top: auto; 
        }

        .report-summary-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.85rem; }
        .report-summary-table th, .report-summary-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
        .report-summary-table th { color: var(--text-secondary); width: 40%; }
        .report-summary-table td { font-weight: 700; color: var(--primary-dark); }

        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 20px; }

        .analyze-btn {
            width: 100%; padding: 16px; background: #cfd8dc; color: #fff; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: 800; cursor: not-allowed; display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 20px; box-shadow: none; transition: all 0.3s;
        }
        .analyze-btn.active { 
            background: linear-gradient(135deg, var(--primary-main), #1a237e); cursor: pointer;
            box-shadow: 0 5px 15px rgba(26, 35, 126, 0.4); transform: translateY(-2px);
        }

        /* â˜… í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ì˜ì—­ */
        .footer-btns { 
            display: flex; gap: 10px; margin-top: 30px; 
            padding: 12px 10px;
        }
        /* ë¶„ì„ í›„ í•˜ë‹¨ ê³ ì • ìŠ¤íƒ€ì¼ */
        .footer-btns.sticky-bottom {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: var(--container-max-width);
            background: rgba(255,255,255,0.97);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
            z-index: 200;
            padding: 12px 15px;
            margin-top: 0;
            border-top: 1px solid #e0e0e0;
            box-sizing: border-box;
        }
        .footer-btn {
            flex: 1; padding: 14px 0; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 700; cursor: pointer; color: white;
            display: flex; justify-content: center; align-items: center; gap: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-pdf { background: #455a64; }
        .btn-pdf:active { background: #37474f; }
        .btn-reserve { background: var(--expert-gold); }
        .btn-reserve:active { background: #e65100; }

        /* ìë™ì €ì¥ í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .save-toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: linear-gradient(135deg, #2e7d32, #43a047);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
            z-index: 9999;
            opacity: 0;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 90%;
            text-align: center;
        }
        .save-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .save-toast i { font-size: 1.1rem; }

        .legal-box { background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 0.75rem; color: #e65100; line-height: 1.4; border: 1px solid #ffe0b2; }
        .legal-check { display: flex; align-items: center; margin-top: 10px; font-weight: bold; cursor: pointer; }
        
        @media print {
            body { background: #fff; }
            .mobile-container { box-shadow: none; max-width: 100%; }
            .no-print, .footer-btns { display: none !important; }
            #result-area { display: block !important; border: 2px solid #000; }
        }
    </style>
</head>
<body>

<!-- ìë™ì €ì¥ í† ìŠ¤íŠ¸ -->
<div class="save-toast" id="save-toast">
    <i class="fas fa-check-circle"></i>
    <span id="save-toast-msg">PDF ìë™ ì €ì¥ ì™„ë£Œ</span>
</div>

<div class="mobile-container">
    <header class="main-header">
        <h1><i class="fas fa-microscope"></i> ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AI</h1>
        <span class="version-badge" id="version-badge" onclick="checkDevMode()">v28.0 Stable</span>
    </header>

    <div class="content">
        <div class="section no-print">
            <div class="section-title"><i class="fas fa-home"></i> ì§„ë‹¨ ê°œìš” (Overview)</div>
            <div class="info-grid-row">
                <div class="input-group"><label class="input-label">ë™</label><input type="text" id="dong" placeholder="101"></div>
                <div class="input-group"><label class="input-label">í˜¸</label><input type="text" id="ho" placeholder="1204"></div>
                <div class="input-group"><label class="input-label">ì¥ì†Œ</label><input type="text" id="location" placeholder="ê±°ì‹¤ì°½"></div>
                <div class="input-group"><label class="input-label">ì¼ì</label><input type="text" id="date" style="color:#1565c0;"></div>
            </div>
            
            <div class="info-triple-row">
                <div class="input-group">
                    <label class="input-label">ì°½í˜¸ ì‚¬ì–‘</label>
                    <select id="window-type">
                        <option value="PVC ì´ì¤‘ì°½">PVC ì´ì¤‘ì°½ (ì¼ë°˜)</option>
                        <option value="ì…ë©´ë¶„í• ì°½">ì…ë©´ë¶„í• ì°½ (ê³ ê¸‰í˜•)</option>
                        <option value="PVC ì‹œìŠ¤í…œì°½í˜¸">PVC ì‹œìŠ¤í…œì°½í˜¸ (TT/LS)</option>
                        <option value="ì•Œë£¨ë¯¸ëŠ„ ë‹¨ì°½">ì•Œë£¨ë¯¸ëŠ„ ë‹¨ì°½ (ë…¸í›„)</option>
                        <option value="ì»¤íŠ¼ì›”(Curtain Wall)">ì»¤íŠ¼ì›” (ì£¼ìƒë³µí•©)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">êµ¬ì¡° íŠ¹ì„±</label>
                    <select id="house-type">
                        <option value="í™•ì¥í˜•(Extension)">ë°œì½”ë‹ˆ í™•ì¥í˜•</option>
                        <option value="ë¹„í™•ì¥(Non-Ext)">ë¹„í™•ì¥ (ê¸°ë³¸í˜•)</option>
                        <option value="í•„ë¡œí‹°/ìµœìƒì¸µ">í•„ë¡œí‹°/ìµœìƒì¸µ</option>
                        <option value="ì¸¡ë²½ì„¸ëŒ€">ì¸¡ë²½ ì„¸ëŒ€ (End)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">ê³ ë ¤ì‚¬í•­</label>
                    <select id="consideration">
                        <option value="ì•Œë£¨ë¯¸ëŠ„ ê°„ë´‰">ì•Œë£¨ë¯¸ëŠ„ ê°„ë´‰</option>
                        <option value="TPS ë‹¨ì—´ê°„ë´‰">TPS ë‹¨ì—´ê°„ë´‰</option>
                        <option value="TGI ë‹¨ì—´ê°„ë´‰">TGI ë‹¨ì—´ê°„ë´‰</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <textarea id="defect-content" placeholder="[ìƒì„¸ ì¦ìƒ] ì˜ˆ: ì•„ì¹¨ë§ˆë‹¤ ìœ ë¦¬ì°½ í•˜ë‹¨ì— ë¬¼ì´ ê³ ì„, ë¶ìª½ ë°© ëª¨ì„œë¦¬ì— ê²€ì€ ê³°íŒ¡ì´ ë°œìƒ ë“±"></textarea>
            </div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-temperature-high"></i> ì •ë°€ ê³„ì¸¡ ë°ì´í„° (Measurement)</div>
            
            <div style="background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 8px;">
                    <div class="input-group">
                        <label class="input-label">ì‹¤ë‚´ì˜¨ë„(Ti)</label>
                        <input type="number" id="temp-in" placeholder="Auto" oninput="calcDewPoint()">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ìƒëŒ€ìŠµë„(RH)</label>
                        <input type="number" id="humid-in" placeholder="Auto" oninput="calcDewPoint()">
                    </div>
                    <div class="input-group">
                        <label class="input-label" style="color:#c62828;">ğŸ”¥ ë…¸ì ì˜¨ë„(Tdp)</label>
                        <input type="text" id="dew-result" placeholder="ìë™ê³„ì‚°" readonly style="background-color:#ffebee; color:#c62828; font-weight:900;">
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-group">
                    <label class="input-label">ğŸ“‰ í‘œë©´ì˜¨ë„(Tsi)</label>
                    <input type="number" id="temp-surf" class="tdr-input" placeholder="ì—´í™”ìƒ Auto">
                    <div style="font-size:0.7rem; color:#ef6c00; margin-top:3px; text-align:center;">* ì—´í™”ìƒ ì‚¬ì§„ ìµœì €ê°’ ìë™ ì…ë ¥</div>
                </div>
                <div class="input-group">
                    <label class="input-label">ì™¸ê¸°ì˜¨ë„(To)</label>
                    <input type="text" id="temp-out" placeholder="Loading.." style="background:#eee;">
                </div>
            </div>

            <div style="margin-top:15px; padding-top:15px; border-top:1px dashed #ccc;">
                <label class="input-label"><i class="fas fa-wind"></i> ê³µê¸°ì§ˆ ì •ë°€ ì§„ë‹¨ (Auto)</label>
                
                <div style="font-size:0.8rem; color:#c62828; margin-bottom:5px; font-weight:bold; text-align:center;">
                    â€» ê²¨ìš¸ì²  ì ì •(ì‹ ì¶•): VAP 1.2kPa â†“ / MIX 7.3g/kg â†“
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label class="input-label" style="font-size:0.75rem;">VAP (ìˆ˜ì¦ê¸°ì••)</label>
                        <input type="number" id="vap-val" class="vap-input" placeholder="kPa" step="0.01">
                    </div>
                    <div>
                        <label class="input-label" style="font-size:0.75rem;">MIX (ì ˆëŒ€ìŠµë„)</label>
                        <input type="number" id="mix-val" class="vap-input" placeholder="g/kg" step="0.01">
                    </div>
                </div>
                <div style="font-size:0.7rem; color:#0277bd; margin-top:5px; text-align:right;">* MR277 ì‚¬ì§„ ë“±ë¡ ì‹œ ìë™ ì…ë ¥ë¨</div>
            </div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-images"></i> í˜„ì¥ ì±„ì¦ (Evidence)</div>
            <div class="photo-stack" id="photo-container">
                
                <div class="upload-wrapper" id="wrap-1">
                    <label class="input-label">1. ê²°ë¡œ/ê³°íŒ¡ì´ ë©”ì¸ (í•„ìˆ˜)</label>
                    <label for="img-1" class="upload-box">
                        <i class="fas fa-camera upload-icon"></i>
                        <span style="font-size:0.8rem;">í„°ì¹˜í•˜ì—¬ ì‚¬ì§„ ì´¬ì˜/ì„ íƒ</span>
                        <img id="view-1" class="preview-img">
                    </label>
                    <input type="file" id="img-1" class="file-input" accept="image/*" onchange="handleImage(this)">
                    <button class="add-photo-btn" onclick="addPhotoInput(this, 'ì¶”ê°€ ì‚¬ì§„')">
                        <i class="fas fa-plus-circle"></i> ì‚¬ì§„ ì¶”ê°€
                    </button>
                </div>

                <div class="upload-wrapper" style="border-color:var(--uv-violet);">
                    <label class="input-label" style="color:var(--uv-violet);">2. UV (ìì™¸ì„ ) í˜•ê´‘ ì´¬ì˜</label>
                    <label for="img-uv" class="upload-box" style="background:#ede7f6;">
                        <i class="fas fa-lightbulb upload-icon" style="color:var(--uv-violet);"></i>
                        <span style="font-size:0.8rem; color:var(--uv-violet);">UV í˜•ê´‘ ì´ë¯¸ì§€</span>
                        <img id="view-uv" class="preview-img">
                    </label>
                    <input type="file" id="img-uv" class="file-input" accept="image/*" onchange="handleImage(this)">
                </div>

                <div class="upload-wrapper" style="border-color:var(--thermal-orange);">
                    <label class="input-label" style="color:var(--thermal-orange);">3. ì—´í™”ìƒ ì¹´ë©”ë¼ (Thermal)</label>
                    <label for="img-thermal" class="upload-box" style="background:#fff3e0;">
                        <i class="fas fa-temperature-high upload-icon" style="color:var(--thermal-orange);"></i>
                        <span style="font-size:0.8rem; color:var(--thermal-orange);">ì—´í™”ìƒ ì´ë¯¸ì§€</span>
                        <img id="view-thermal" class="preview-img">
                    </label>
                    <input type="file" id="img-thermal" class="file-input" accept="image/*" onchange="handleImage(this); autoFillFromImage(this, 'thermal')">
                    <button class="add-photo-btn" onclick="addPhotoInput(this, 'ì—´í™”ìƒ ì‚¬ì§„')"><i class="fas fa-plus-circle"></i> ì‚¬ì§„ ì¶”ê°€</button>
                </div>

                <div class="upload-wrapper" style="border-color:var(--primary-main);">
                    <label class="input-label" style="color:var(--primary-main);">4. FLIR MR277 (ìŠµë„/VAP ê³„ì¸¡)</label>
                    <label for="img-mr277" class="upload-box" style="background:#e3f2fd;">
                        <i class="fas fa-ruler-combined upload-icon" style="color:var(--primary-main);"></i>
                        <span style="font-size:0.8rem; color:var(--primary-main);">MR277 í™”ë©´</span>
                        <img id="view-mr277" class="preview-img">
                    </label>
                    <input type="file" id="img-mr277" class="file-input" accept="image/*" onchange="handleImage(this); autoFillFromImage(this, 'mr277')">
                    <button class="add-photo-btn" onclick="addPhotoInput(this, 'MR277 ì‚¬ì§„')"><i class="fas fa-plus-circle"></i> ì‚¬ì§„ ì¶”ê°€</button>
                </div>

                <div class="upload-wrapper" style="border-color:var(--moisture-blue);">
                    <label class="input-label" style="color:var(--moisture-blue);">5. FLIR MR12 ë³¼ í”„ë¡œë¸Œ (ë¹„íŒŒê´´)</label>
                    <label for="img-mr12" class="upload-box" style="background:#e1f5fe;">
                        <i class="fas fa-bullseye upload-icon" style="color:var(--moisture-blue);"></i>
                        <span style="font-size:0.8rem; color:var(--moisture-blue);">í•¨ìˆ˜ìœ¨ ì¸¡ì • ì´ë¯¸ì§€</span>
                        <img id="view-mr12" class="preview-img">
                    </label>
                    <input type="file" id="img-mr12" class="file-input" accept="image/*" onchange="handleImage(this)">
                    <button class="add-photo-btn" onclick="addPhotoInput(this, 'ë³¼ í”„ë¡œë¸Œ ì‚¬ì§„')"><i class="fas fa-plus-circle"></i> ì‚¬ì§„ ì¶”ê°€</button>
                </div>

                <div class="upload-wrapper" style="border-color:var(--sonic-purple);">
                    <label class="input-label" style="color:var(--sonic-purple);">6. ì´ˆìŒíŒŒ ìŒí–¥ ì¹´ë©”ë¼ (Sonic)</label>
                    <label for="img-sonic" class="upload-box" style="background:#f3e5f5;">
                        <i class="fas fa-wave-square upload-icon" style="color:var(--sonic-purple);"></i>
                        <span style="font-size:0.8rem; color:var(--sonic-purple);">ìŒí–¥ ì¹´ë©”ë¼ ì´ë¯¸ì§€</span>
                        <img id="view-sonic" class="preview-img">
                    </label>
                    <input type="file" id="img-sonic" class="file-input" accept="image/*" onchange="handleImage(this)">
                    <button class="add-photo-btn" onclick="addPhotoInput(this, 'ì´ˆìŒíŒŒ ì‚¬ì§„')"><i class="fas fa-plus-circle"></i> ì‚¬ì§„ ì¶”ê°€</button>
                </div>
            </div>
        </div>

        <div class="legal-box no-print">
            <strong>[ë¶„ì„ ì „ í•„ìˆ˜ ë™ì˜]</strong><br>
            ë³¸ ë¦¬í¬íŠ¸ëŠ” <strong>ê³µê°œëœ ê±´ì¶•ë¬¼ë¦¬ í‘œì¤€ ë°ì´í„°(TDR, Dew Point ë“±)</strong>ë¥¼ ê¸°ë°˜ìœ¼ë¡œ AIê°€ ìƒì„±í•œ 'ì°¸ê³ ìš© ê¸°ìˆ  ì†Œê²¬'ì…ë‹ˆë‹¤. 'ê¸°ìˆ ì‚¬ë²•'ì— ì˜í•œ ê³µì¸ ê°ì •ì„œê°€ ì•„ë‹ˆë©°, ë²•ì  ë¶„ìŸì˜ ì¦ê±°ë¡œ íš¨ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.
            <label class="legal-check">
                <input type="checkbox" id="legal-agree" onchange="toggleAnalyzeBtn()" style="width:20px; height:20px; margin-right:8px;">
                ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.
            </label>
        </div>

        <button class="analyze-btn no-print" id="analyze-btn" onclick="startAnalysis()" disabled>
            <i class="fas fa-cogs"></i> ì „ë¬¸ê°€ ë ˆë²¨ ì •ë°€ ë¶„ì„ ì‹œì‘
        </button>

        <div id="result-area">
            <div class="section-title" style="margin-top:0;"><i class="fas fa-file-signature"></i> ê²°ë¡œ ì •ë°€ ì§„ë‹¨ ì†Œê²¬ì„œ</div>
            
            <div class="report-badge">
                <i class="fas fa-check-circle"></i>
                ë³¸ ê²°ê³¼ëŠ” <strong>ê±´ì¶• ë¬¼ë¦¬ í‘œì¤€ ë°ì´í„° ë° ê²°ë¡œ ì‚¬ë¡€ ë¹…ë°ì´í„°</strong>ë¥¼ ê·¼ê±°ë¡œ AIê°€ TDR(ì˜¨ë„ì°¨ì´ë¹„ìœ¨) ë° VAP/MIX(ê³µê¸°ì§ˆ) ë¶„ì„ì„ ìˆ˜í–‰í•œ <strong>ì°¸ê³ ìš© ê¸°ìˆ  ì†Œê²¬</strong>ì…ë‹ˆë‹¤.
            </div>

            <div class="input-label" style="margin-bottom:5px;">[í˜„ì¥ ì±„ì¦ ë°ì´í„°]</div>
            <div id="report-photo-gallery" class="report-gallery"></div>

            <table class="report-summary-table">
                <tr><th>ì§„ë‹¨ ì¼ì</th><td id="rep-date"></td></tr>
                <tr><th>ì§„ë‹¨ ëŒ€ìƒ</th><td id="rep-loc"></td></tr>
                <tr><th>êµ¬ì¡°/ì‚¬ì–‘</th><td id="rep-type"></td></tr>
            </table>

            <div id="loading-spinner" style="text-align:center; padding:50px 20px; display:none; background:linear-gradient(135deg, #e8eaf6, #f3e5f5); border-radius:12px; margin:20px 0;">
                <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary-main)"></i>
                <p style="margin-top:20px; font-weight:800; color:var(--primary-dark); font-size:1.05rem;">
                    <i class="fas fa-brain" style="margin-right:5px;"></i> AI ì •ë°€ ë¶„ì„ ì§„í–‰ ì¤‘...
                </p>
                <p style="margin-top:8px; font-weight:500; color:var(--text-secondary); font-size:0.85rem;">
                    ê±´ì¶• ë¬¼ë¦¬ ë°ì´í„° ëŒ€ì¡° ë° VAP/MIX ê³µê¸°ì§ˆ ê¸°ì¤€ ì ìš© ì¤‘<br>
                    (ì•½ 15~30ì´ˆ ì†Œìš”)
                </p>
            </div>
            
            <div id="analysis-content" style="font-size:0.95rem; line-height:1.7;"></div>
            
            <div id="chart-section" style="display:none; margin-top:30px; border-top:2px dashed #eee; padding-top:20px;">
                <div class="section-title"><i class="fas fa-chart-pie"></i> ì›ì¸ ë¹„ìœ¨ ë¶„ì„ (AI ì¶”ì •)</div>
                <div id="chart_div" class="chart-container"></div>
                
                <div style="margin-top:30px; font-size:0.7rem; color:#999; text-align:center; border:1px solid #ddd; padding:10px;">
                    â€» ë³¸ ë¬¸ì„œëŠ” AIê°€ ê³µê°œ ë°ì´í„°ë¥¼ ì¢…í•©Â·ë¶„ì„í•˜ì—¬ ì‘ì„±í•œ <strong>ì°¸ê³ ìš© ìë£Œ</strong>ì…ë‹ˆë‹¤. ë²•ì  íš¨ë ¥ì´ ì—†ìœ¼ë©°, íŠ¹ì • ì‹œê³µì‚¬ ë˜ëŠ” ê°œì¸ì˜ ì±…ì„ì„ íŒì •í•˜ëŠ” ë¬¸ì„œê°€ ì•„ë‹™ë‹ˆë‹¤. ì •í™•í•œ ì›ì¸ ê·œëª…ì„ ìœ„í•´ì„œëŠ” ë³„ë„ì˜ í˜„ì¥ ì •ë°€ ì¡°ì‚¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <!-- â˜… í•˜ë‹¨ ë²„íŠ¼: no-print ëŒ€ì‹  ë³„ë„ IDë¡œ ê´€ë¦¬, ë¶„ì„ í›„ì—ë„ í•­ìƒ í‘œì‹œ -->
        <div class="footer-btns" id="footer-action-btns">
            <button class="footer-btn btn-reserve" onclick="window.location.href='tel:01023220949'">
                <i class="fas fa-phone-alt"></i> ê¸°ìˆ  ìƒë‹´ ì—°ê²°
            </button>
            <button class="footer-btn btn-pdf" onclick="savePdfAuto()">
                <i class="fas fa-file-download"></i> PDF ë³´ê³ ì„œ ì €ì¥
            </button>
        </div>

        <div class="footer-info no-print" style="text-align:center; margin-top:30px; font-size:0.8rem; color:#aaa; padding-bottom: 60px;">
            <p><strong>ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ</strong> | ë°ì´í„° ê¸°ë°˜ ê²°ë¡œ ì†”ë£¨ì…˜</p>
        </div>
    </div>
</div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        google.charts.load("current", {packages:["corechart"]});
        const API_KEY = "AIzaSyCVgdFT-YkZYlmxcnQ8-rAgejDjRzFK6ns";
         
        const today = new Date();
        const dateStr = `${today.getFullYear()}.${today.getMonth() + 1}.${today.getDate()}`;
        document.getElementById('date').value = dateStr;

        let clickCount = 0; let clickTimer;

        window.checkDevMode = function() {
            clearTimeout(clickTimer); clickCount++;
            if (clickCount === 5) {
                const badge = document.getElementById('version-badge');
                if(badge.classList.contains('dev-active')) {
                    badge.classList.remove('dev-active'); alert("ê°œë°œì ëª¨ë“œ í•´ì œ");
                } else {
                    badge.classList.add('dev-active'); alert("ğŸ¸ ê°œë°œì ëª¨ë“œ í™œì„±í™”!");
                }
                clickCount = 0;
            }
            clickTimer = setTimeout(() => { clickCount = 0; }, 1000);
        };

        const CONDENSATION_DB = [
            {
                id: "C-001",
                category: "êµ¬ì¡°ì²´(Structure)",
                diagnosis: "ê¸°í•˜í•™ì  ì—´êµ (Geometric Thermal Bridge)",
                mechanism: "ê±´ë¬¼ ì½”ë„ˆ ë¶€ìœ„ëŠ” ì™¸ë¶€ ë°©ì—´ ë©´ì ì´ ë‚´ë¶€ í¡ì—´ ë©´ì ë³´ë‹¤ ë„“ì–´ êµ¬ì¡°ì ìœ¼ë¡œ ì˜¨ë„ê°€ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤. í•´ë‹¹ ë¶€ìœ„ì˜ TDR(ì˜¨ë„ì°¨ì´ë¹„ìœ¨)ì´ ê¸°ì¤€ì¹˜ë¥¼ ì´ˆê³¼í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.",
                solution: "1. ê°€êµ¬ì™€ ë²½ì²´ ì‚¬ì´ 10cm ì´ìƒ ì´ê²© (ê³µê¸° ìˆœí™˜ í†µë¡œ í™•ë³´)\n2. ì‹¤ë‚´ ìŠµë„ 45% ì´í•˜ ê´€ë¦¬ (ì œìŠµê¸° ê°€ë™)\n3. [ì‹œê³µ] ì½”ë„ˆ ë¶€ìœ„ ë‹¨ì—´ì¬(ì´ë³´ë“œ ë“±) ê¸°ë°€ ë§ëŒ ì‹œê³µ"
            },
            {
                id: "C-002",
                category: "ì°½í˜¸(Window)",
                diagnosis: "ê°„ë´‰(Spacer) ì—´êµ ë° í”„ë ˆì„ ë‹¨ì—´ ì„±ëŠ¥ ë¶€ì¡±",
                mechanism: "ë³µì¸µ ìœ ë¦¬ í…Œë‘ë¦¬ì˜ ì•Œë£¨ë¯¸ëŠ„ ê°„ë´‰(Spacer)ì´ ì™¸ë¶€ ëƒ‰ê¸°ë¥¼ ì‹¤ë‚´ë¡œ ì „ë‹¬í•˜ëŠ” 'ì„ í˜• ì—´êµ' í˜„ìƒì…ë‹ˆë‹¤. ìœ ë¦¬ ëë‹¨ í‘œë©´ ì˜¨ë„ê°€ ë…¸ì  ì´í•˜ë¡œ ë–¨ì–´ì ¸ ë°œìƒí•©ë‹ˆë‹¤.",
                solution: "1. [ì„ì‹œ] ì•¼ê°„ì— ì»¤íŠ¼/ë¸”ë¼ì¸ë“œ í•˜ë‹¨ì„ 10cm ë„ì›Œì„œ í†µê¸°ì„± í™•ë³´ (Cold Draft ë°©ì§€)\n2. [ì„ì‹œ] ì°½í˜¸ ë¬¼êµ¬ë© ë°©í’ìº¡ ì„¤ì¹˜\n3. [ê·¼ë³¸] ë‹¨ì—´ ê°„ë´‰(TPS)ì´ ì ìš©ëœ ë¡œì´(Low-E) ë³µì¸µ ìœ ë¦¬ë¡œ êµì²´"
            },
            {
                id: "C-003",
                category: "ê¸°ë°€(Airtightness)",
                diagnosis: "ì¹¨ê¸°(Infiltration)ì— ì˜í•œ ë‚´ë¶€ ê²°ë¡œ",
                mechanism: "ê¸°ë°€ì¸µì´ íŒŒê´´ëœ í‹ˆìƒˆ(ì „ì„ ê´€, ë°°ê´€ ì£¼ìœ„)ë¡œ ì™¸ë¶€ì˜ ì°¨ê°€ìš´ ê³µê¸°ê°€ ë‹¨ì—´ì¬ì™€ ë‚´ë²½ ì‚¬ì´ë¡œ ì¹¨íˆ¬í•˜ì—¬ ë²½ì²´ ë‚´ë¶€ ì˜¨ë„ë¥¼ ë‚®ì¶”ê³  ìŠµê¸°ë¥¼ ì‘ê²°ì‹œí‚µë‹ˆë‹¤.",
                solution: "1. ì½˜ì„¼íŠ¸ ì»¤ë²„ ë¶„ë¦¬ í›„ ë‚´ë¶€ ì „ì„ ê´€ ì£¼ë³€ì„ 'ê¸°ë°€ í…Œì´í”„' ë˜ëŠ” 'ìš°ë ˆíƒ„ í¼'ìœ¼ë¡œ ë°€ì‹¤ ì¶©ì§„\n2. ì—ì–´ì»¨ ë°°ê´€ êµ¬ë© ì‹¤ë¦¬ì½˜/í¼í‹° ì¬ë§ˆê°\n3. ë°©í’ ì»¤ë²„ ì„¤ì¹˜"
            }
        ];

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current=temperature_2m&timezone=auto`;
                    const res = await fetch(url);
                    if(res.ok) {
                        const data = await res.json();
                        document.getElementById('temp-out').value = data.current.temperature_2m.toFixed(1);
                    }
                } catch(e) {}
            });
        }

        window.calcDewPoint = function() {
            const t = parseFloat(document.getElementById('temp-in').value);
            const h = parseFloat(document.getElementById('humid-in').value);
            if(!isNaN(t) && !isNaN(h)) {
                const a = 17.27, b = 237.7;
                const alpha = ((a*t)/(b+t)) + Math.log(h/100.0);
                const dp = (b*alpha)/(a-alpha);
                document.getElementById('dew-result').value = dp.toFixed(1) + "Â°C";
            }
        }

        window.handleImage = function(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wrapper = input.closest('.upload-wrapper');
                    const img = wrapper.querySelector('.preview-img');
                    const box = wrapper.querySelector('.upload-box');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    box.querySelectorAll('i, span').forEach(el => el.style.display = 'none');
                    wrapper.classList.add('filled');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.autoFillFromImage = async function(input, type) {
            if(!input.files || !input.files[0]) return;
            const targetIds = type === 'mr277' ? ['temp-in', 'humid-in', 'vap-val', 'mix-val'] : ['temp-surf'];
            targetIds.forEach(id => {
                document.getElementById(id).classList.add('scanning');
                document.getElementById(id).value = ''; 
                document.getElementById(id).placeholder = "Scanning...";
            });

            try {
                const file = input.files[0];
                const reader = new FileReader();
                const base64Promise = new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
                const base64Data = await base64Promise;
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });

                let prompt = "";
                if(type === 'mr277') {
                    prompt = `Analyze this FLIR MR277 instrument screen. Extract numerical values for:
                        1. Temperature (C)
                        2. Relative Humidity (%)
                        3. Vapor Pressure (VAP, kPa)
                        4. Mixing Ratio (Mix, g/kg or GPP)
                        Return ONLY a JSON object: {"temp": number, "humid": number, "vap": number, "mix": number}.`;
                } else if(type === 'thermal') {
                    prompt = `Analyze this thermal camera image. Find 'Minimum' (Lo/Min) temperature. Return ONLY a JSON object: {"min_temp": number}.`;
                }

                const result = await model.generateContent({ 
                    contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: file.type, data: base64Data } }] }] 
                });
                const response = await result.response;
                const text = response.text();
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                
                if(jsonMatch) {
                    const data = JSON.parse(jsonMatch[0]);
                    if(type === 'mr277') {
                        if(data.temp) document.getElementById('temp-in').value = data.temp;
                        if(data.humid) document.getElementById('humid-in').value = data.humid;
                        if(data.vap) document.getElementById('vap-val').value = data.vap;
                        if(data.mix) document.getElementById('mix-val').value = data.mix;
                        calcDewPoint(); 
                    } else if(type === 'thermal') {
                        if(data.min_temp) document.getElementById('temp-surf').value = data.min_temp;
                    }
                }
            } catch(e) {
                targetIds.forEach(id => document.getElementById(id).placeholder = "ì§ì ‘ì…ë ¥");
            } finally {
                targetIds.forEach(id => document.getElementById(id).classList.remove('scanning'));
            }
        };

        window.addPhotoInput = function(btnElement, labelText) {
            const wrapper = btnElement.closest('.upload-wrapper');
            const container = document.getElementById('photo-container');
            const newDiv = document.createElement('div');
            newDiv.className = 'upload-wrapper';
            newDiv.style.marginTop = '15px'; 
            const uniqueId = Date.now();
            newDiv.innerHTML = `<label class="input-label" style="color:#546e7a;">${labelText} (ì¶”ê°€)</label><label for="img-${uniqueId}" class="upload-box"><i class="fas fa-plus upload-icon" style="color:#b0bec5;"></i><img id="view-${uniqueId}" class="preview-img"></label><input type="file" id="img-${uniqueId}" class="file-input" accept="image/*" onchange="handleImage(this)"><button class="add-photo-btn" onclick="addPhotoInput(this, '${labelText}')"><i class="fas fa-plus-circle"></i> ì‚¬ì§„ ì¶”ê°€</button>`;
            if (wrapper.nextSibling) container.insertBefore(newDiv, wrapper.nextSibling); else container.appendChild(newDiv);
        };

        window.toggleAnalyzeBtn = function() {
            const chk = document.getElementById('legal-agree');
            const btn = document.getElementById('analyze-btn');
            btn.disabled = !chk.checked;
            if(chk.checked) btn.classList.add('active'); else btn.classList.remove('active');
        };

        // â˜… í† ìŠ¤íŠ¸ í‘œì‹œ í•¨ìˆ˜
        function showToast(msg, duration = 3000) {
            const toast = document.getElementById('save-toast');
            const toastMsg = document.getElementById('save-toast-msg');
            toastMsg.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // â˜… PDF íŒŒì¼ëª… ìƒì„± í•¨ìˆ˜
        function generatePdfFilename() {
            const dong = document.getElementById('dong').value || '000';
            const ho = document.getElementById('ho').value || '0000';
            const dateVal = document.getElementById('date').value || '';
            const dateClean = dateVal.replace(/\./g, '');
            return `${dong}ë™${ho}í˜¸_ê²°ë¡œì§„ë‹¨ë³´ê³ ì„œ_${dateClean}.pdf`;
        }

        // â˜… PDF ìƒì„± ê³µí†µ í•¨ìˆ˜ (í´ë¡  ê¸°ë°˜ - ì „ì²´ ì½˜í…ì¸  ìº¡ì²˜ ë³´ì¥)
        async function generatePdf(isAuto = false) {
            const resultArea = document.getElementById('result-area');
            if (resultArea.style.display === 'none' || resultArea.style.display === '') {
                if (!isAuto) alert('ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            const filename = generatePdfFilename();
            showToast(`ğŸ“„ ${isAuto ? 'ìë™' : 'PDF'} ì €ì¥ ì¤‘: ${filename}`);

            try {
                // 1) result-areaë¥¼ í´ë¡ í•˜ì—¬ ë³„ë„ ì»¨í…Œì´ë„ˆì— ë°°ì¹˜ (ë†’ì´ ì œí•œ ì—†ì´ ì „ì²´ ìº¡ì²˜)
                const clone = resultArea.cloneNode(true);
                clone.style.position = 'absolute';
                clone.style.left = '-9999px';
                clone.style.top = '0';
                clone.style.width = '550px';       // A4 ë„ˆë¹„ì— ë§ì¶¤
                clone.style.display = 'block';
                clone.style.overflow = 'visible';
                clone.style.height = 'auto';
                clone.style.maxHeight = 'none';
                clone.style.border = '2px solid #283593';
                clone.style.background = '#fff';
                clone.style.padding = '20px';
                
                // ë¡œë”© ìŠ¤í”¼ë„ˆ ì œê±° (ë¶„ì„ ì™„ë£Œ í›„ì´ë¯€ë¡œ)
                const spinner = clone.querySelector('#loading-spinner');
                if (spinner) spinner.style.display = 'none';
                
                // ë¶„ì„ ë‚´ìš© & ì°¨íŠ¸ ë³´ì´ë„ë¡ ê°•ì œ ì„¤ì •
                const content = clone.querySelector('#analysis-content');
                if (content) { content.style.display = 'block'; content.style.overflow = 'visible'; }
                const chart = clone.querySelector('#chart-section');
                if (chart) { chart.style.display = 'block'; chart.style.overflow = 'visible'; }
                
                // ì°¨íŠ¸ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ì—¬ ì‚½ì… (Google ChartsëŠ” SVGë¼ html2canvasì—ì„œ ë¬¸ì œ)
                const chartDiv = document.getElementById('chart_div');
                if (chartDiv) {
                    const svg = chartDiv.querySelector('svg');
                    if (svg) {
                        const svgData = new XMLSerializer().serializeToString(svg);
                        const canvas = document.createElement('canvas');
                        canvas.width = svg.clientWidth * 2 || 600;
                        canvas.height = svg.clientHeight * 2 || 700;
                        const ctx = canvas.getContext('2d');
                        ctx.scale(2, 2);
                        const img = new Image();
                        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                        const url = URL.createObjectURL(svgBlob);
                        
                        await new Promise((resolve) => {
                            img.onload = () => {
                                ctx.drawImage(img, 0, 0);
                                URL.revokeObjectURL(url);
                                const cloneChartDiv = clone.querySelector('#chart_div');
                                if (cloneChartDiv) {
                                    cloneChartDiv.innerHTML = '';
                                    const chartImg = document.createElement('img');
                                    chartImg.src = canvas.toDataURL('image/png');
                                    chartImg.style.width = '100%';
                                    chartImg.style.height = 'auto';
                                    cloneChartDiv.appendChild(chartImg);
                                    cloneChartDiv.style.height = 'auto';
                                }
                                resolve();
                            };
                            img.onerror = () => { URL.revokeObjectURL(url); resolve(); };
                            img.src = url;
                        });
                    }
                }
                
                document.body.appendChild(clone);

                // 2) html2pdfë¡œ í´ë¡  ìº¡ì²˜
                const opt = {
                    margin:       [8, 5, 12, 5],
                    filename:     filename,
                    image:        { type: 'jpeg', quality: 0.92 },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true, 
                        logging: false, 
                        scrollY: 0,
                        scrollX: 0,
                        windowWidth: 600,
                        allowTaint: true
                    },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['css', 'legacy'], avoid: ['img', '.report-img-item', '.report-summary-table', 'tr'] }
                };

                await html2pdf().set(opt).from(clone).save();
                
                // 3) í´ë¡  ì œê±°
                document.body.removeChild(clone);
                
                showToast(`âœ… ${isAuto ? 'ìë™' : ''} ì €ì¥ ì™„ë£Œ: ${filename}`, 4000);
            } catch(err) {
                showToast(`âŒ PDF ì €ì¥ ì‹¤íŒ¨. ${isAuto ? 'ìˆ˜ë™ ì €ì¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”.' : 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'}`, 3000);
                console.error('PDF save error:', err);
                // í´ë¡ ì´ ë‚¨ì•„ìˆìœ¼ë©´ ì œê±°
                const orphan = document.querySelector('[style*="-9999px"]');
                if (orphan && orphan.id !== 'result-area') orphan.remove();
            }
        }

        // â˜… ìˆ˜ë™ PDF ì €ì¥
        window.savePdfAuto = function() { generatePdf(false); };

        // â˜… ìë™ PDF ì €ì¥ (ë¶„ì„ ì™„ë£Œ í›„ í˜¸ì¶œ - ì°¨íŠ¸ ë Œë”ë§ ëŒ€ê¸° 5ì´ˆ)
        function autoSavePdf() {
            setTimeout(() => { generatePdf(true); }, 5000);
        }

        window.startAnalysis = async function() {
            const loading = document.getElementById('loading-spinner');
            const resultArea = document.getElementById('result-area');
            const contentDiv = document.getElementById('analysis-content');
            const chartSection = document.getElementById('chart-section');
            const gallery = document.getElementById('report-photo-gallery');
            const footerBtns = document.getElementById('footer-action-btns');

            const tempIn = document.getElementById('temp-in').value || 20;
            const tempOut = document.getElementById('temp-out').value || -5;
            const tempSurf = document.getElementById('temp-surf').value; 
            const humid = document.getElementById('humid-in').value;
            const dew = document.getElementById('dew-result').value;
            const defect = document.getElementById('defect-content').value;
            
            const winType = document.getElementById('window-type').value;
            const houseType = document.getElementById('house-type').value;
            const consideration = document.getElementById('consideration').value;
            const vapVal = document.getElementById('vap-val').value;
            const mixVal = document.getElementById('mix-val').value;
            
            document.getElementById('rep-date').innerText = document.getElementById('date').value;
            document.getElementById('rep-loc').innerText = `${document.getElementById('dong').value}ë™ ${document.getElementById('ho').value}í˜¸ (${document.getElementById('location').value})`;
            document.getElementById('rep-type').innerText = `${winType} / ${houseType} / ${consideration}`;

            let imageParts = [];
            gallery.innerHTML = ''; 
            
            document.querySelectorAll('.preview-img').forEach((img, idx) => {
                if(img.src.startsWith('data:image')) {
                    imageParts.push({ inline_data: { mime_type: "image/jpeg", data: img.src.split(',')[1] } });
                    const div = document.createElement('div');
                    div.className = 'report-img-item';
                    div.innerHTML = `<img src="${img.src}"><div class="report-img-caption">í˜„ì¥ ì‚¬ì§„ ${idx+1}</div>`;
                    gallery.appendChild(div);
                }
            });

            if(imageParts.length === 0) { alert("ì‚¬ì§„ì„ ìµœì†Œ 1ì¥ ì´ìƒ ë“±ë¡í•´ì£¼ì„¸ìš”."); return; }

            // â˜… ìˆ˜ì •: .no-printë§Œ ìˆ¨ê¸°ë˜, footer-action-btnsëŠ” ì œì™¸
            document.querySelectorAll('.no-print').forEach(el => {
                el.style.display = 'none';
            });
            
            // â˜… í•˜ë‹¨ ë²„íŠ¼ì€ í•­ìƒ í‘œì‹œ + í•˜ë‹¨ ê³ ì • ëª¨ë“œ ì „í™˜
            footerBtns.style.display = 'flex';
            footerBtns.classList.add('sticky-bottom');

            resultArea.style.display = 'block';
            loading.style.display = 'block';
            contentDiv.style.display = 'none';
            chartSection.style.display = 'none';
            
            // ë¡œë”© ìŠ¤í”¼ë„ˆê°€ í™”ë©´ì— ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
            setTimeout(() => {
                loading.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);

            let tdrVal = 0;
            let tdrMsg = "ë°ì´í„° ë¶€ì¡±";
            if(tempSurf && tempIn && tempOut) {
                let den = parseFloat(tempIn) - parseFloat(tempOut);
                if(den === 0) den = 1;
                tdrVal = (parseFloat(tempIn) - parseFloat(tempSurf)) / den;
                tdrVal = tdrVal.toFixed(2);
                if(tdrVal > 0.28) tdrMsg = `TDR ${tdrVal} (ê¸°ì¤€ 0.28 ì´ˆê³¼ -> ë‹¨ì—´ ì„±ëŠ¥ ë¯¸ë‹¬ ìœ ë ¥)`;
                else tdrMsg = `TDR ${tdrVal} (ê¸°ì¤€ 0.28 ì´í•˜ -> ë‹¨ì—´ ì–‘í˜¸, í™˜ê¸° ë¶€ì¡± ì˜ì‹¬)`;
            }

            let spacerLogic = "";
            if (consideration.includes("TPS") || consideration.includes("TGI")) {
                spacerLogic = "í˜„ì¬ 'ë‹¨ì—´ ê°„ë´‰(TPS/TGI)'ì´ ì ìš©ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ê°„ë´‰ìœ¼ë¡œ ì¸í•œ ì—´êµ(Cold Bridge)ëŠ” ê²°ë¡œì˜ ì£¼ëœ ì›ì¸ì—ì„œ **ì œì™¸**í•˜ì‹­ì‹œì˜¤.";
            } else {
                spacerLogic = "ì•Œë£¨ë¯¸ëŠ„ ê°„ë´‰ì´ ì ìš©ë˜ì—ˆìœ¼ë¯€ë¡œ, ìœ ë¦¬ í…Œë‘ë¦¬ì˜ ì—´êµ í˜„ìƒì„ ì§€ì í•˜ì‹­ì‹œì˜¤.";
            }

            let slidingLogic = "ë¯¸ì„œê¸°(Sliding) ì°½í˜¸ì˜ íŠ¹ì„±ìƒ ë ˆì¼ í‹ˆìƒˆë¡œ ì™¸í’(Infiltration)ì´ ìœ ì…ë˜ì–´ ê²°ë¡œë¥¼ ì‹¬í™”ì‹œí‚¬ ìˆ˜ ìˆìŒì„ ì–¸ê¸‰í•˜ì‹­ì‹œì˜¤. ë‹¨, **'ì°½í˜¸ êµì²´'ë¼ëŠ” ë‹¨ì–´ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ê³ **, ëª¨í—¤ì–´ êµì²´ë‚˜ í’ì§€íŒ ì„¤ì¹˜ ë“± ë³´ìˆ˜ ë°©ë²•ì„ ì œì•ˆí•˜ì‹­ì‹œì˜¤.";

            const currentMonth = new Date().getMonth() + 1;
            const isWinter = (currentMonth >= 11 || currentMonth <= 2);
            
            let airQualityLogic = "";
            let vapMixDiagnosis = "";
            if(vapVal && mixVal) {
                let winterGuide = "";
                if(isWinter) {
                    winterGuide = "í˜„ì¬ ì§„ë‹¨ ì‹œì ì€ **ê²¨ìš¸ì² **ì´ë©°, **ì‹ ì¶• ì•„íŒŒíŠ¸ ê¸°ì¤€ ì ì • ê³µê¸°ì§ˆì€ VAP 1.2kPa ì´í•˜, MIX 7.3g/kg ì´í•˜**ì…ë‹ˆë‹¤. ì´ ìˆ˜ì¹˜ë¥¼ ì´ˆê³¼í•˜ë©´ í™˜ê¸° ë¶€ì¡±ì´ ì›ì¸ì¼ ê°€ëŠ¥ì„±ì´ ë†’ê³ , ì´í•˜ë¼ë©´ ë‹¨ì—´ ë¯¸í¡ì´ ì›ì¸ì¼ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤.";
                }
                airQualityLogic = `[ì¤‘ìš”] ê³µê¸°ì§ˆ ë°ì´í„°(VAP: ${vapVal}kPa, MIX: ${mixVal}g/kg) ë¶„ì„. ${winterGuide}`;
                
                // VAP/MIX ê¸°ì¤€ê°’ ëŒ€ë¹„ ìƒì„¸ ì›ì¸ íŒë³„ ë¡œì§
                const vapNum = parseFloat(vapVal);
                const mixNum = parseFloat(mixVal);
                const vapOver = vapNum > 1.2;
                const mixOver = mixNum > 7.3;
                
                if(vapOver && mixOver) {
                    vapMixDiagnosis = `
                    8. **[í•µì‹¬] ìˆ˜ì¦ê¸°ì••/ì ˆëŒ€ìŠµë„ ìƒì„¸ ì›ì¸ ë¶„ì„ (ë°˜ë“œì‹œ í¬í•¨)**:
                       - ì¸¡ì •ê°’: VAP ${vapVal}kPa (ê¸°ì¤€ 1.2kPa ëŒ€ë¹„ **${(vapNum - 1.2).toFixed(2)}kPa ì´ˆê³¼**), MIX ${mixVal}g/kg (ê¸°ì¤€ 7.3g/kg ëŒ€ë¹„ **${(mixNum - 7.3).toFixed(2)}g/kg ì´ˆê³¼**)
                       - VAPê³¼ MIX ëª¨ë‘ ê¸°ì¤€ ì´ˆê³¼ì´ë¯€ë¡œ, **ì‹¤ë‚´ ìˆ˜ì¦ê¸° ê³¼ë‹¤ ìƒíƒœ**ì…ë‹ˆë‹¤.
                       - ë°˜ë“œì‹œ ì•„ë˜ 3ê°€ì§€ ì›ì¸ ê°€ëŠ¥ì„±ì„ **êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„**í•˜ì‹­ì‹œì˜¤:
                         (A) **ê±°ì£¼ì ìƒí™œìŠµê´€ ì›ì¸**: ë¹¨ë˜ ì‹¤ë‚´ê±´ì¡°, ì¥ì‹œê°„ ì¡°ë¦¬(ê°€ìŠ¤ë ˆì¸ì§€), ê°€ìŠµê¸° ê³¼ë‹¤ ì‚¬ìš©, í™˜ê¸° ë¯¸ì‹¤ì‹œ, ìš•ì‹¤ ë¬¸ ê°œë°©, ìˆ˜ì¡±ê´€/ì–´í•­, ì‹¤ë‚´ í™”ë¶„ ê³¼ë‹¤ ë“± â†’ ìˆ˜ì¦ê¸° ë°œìƒëŸ‰ ê³¼ë‹¤
                         (B) **ë‹¨ì—´ ì„±ëŠ¥ ê´€ë ¨ ì›ì¸** (AI ë¶„ì„ ì†Œê²¬): ë²½ì²´/ì°½í˜¸ ë‹¨ì—´ì„±ëŠ¥ì´ ì„¤ê³„ ê¸°ì¤€ ëŒ€ë¹„ ë¯¸í¡í•  ê°€ëŠ¥ì„± â†’ í‘œë©´ì˜¨ë„ ì €í•˜ â†’ êµ­ë¶€ì  ìƒëŒ€ìŠµë„ ìƒìŠ¹ â†’ ê²°ë¡œ ë°œìƒ (ì´ ê²½ìš° TDRê°’ê³¼ êµì°¨ ê²€ì¦)
                         (C) **ê¸°íƒ€ ë³µí•© ì›ì¸** (AI ë¶„ì„ ì†Œê²¬): ì´ˆê¸° ê±´ì¶•ë¬¼ ìŠµê¸°(ì½˜í¬ë¦¬íŠ¸ ì”ì—¬ ìˆ˜ë¶„), ì§€í•˜ ìŠµê¸° ìœ ì…, ë°°ê´€ ëˆ„ìˆ˜ ê°€ëŠ¥ì„±, í™˜ê¸° ì‹œìŠ¤í…œ(ì „ì—´êµí™˜ê¸°) ë¯¸ê°€ë™ ë˜ëŠ” ê³ ì¥, ê¸°ë°€ì„± ì €í•˜ì— ì˜í•œ ì™¸ë¶€ ìŠµê¸° ì¹¨íˆ¬
                       - TDRê°’(${tdrMsg})ê³¼ êµì°¨ ë¶„ì„í•˜ì—¬ **ì£¼ëœ ì›ì¸ì´ ê±°ì£¼ìŠµê´€ì¸ì§€ ë‹¨ì—´ ì„±ëŠ¥ ë¶€ì¡±ì¸ì§€** AI ì†Œê²¬ì„ ì œì‹œí•˜ì‹­ì‹œì˜¤.
                    9. **[í•µì‹¬] ì›ì¸ë³„ ë§ì¶¤ ìˆ˜ë¦¬/ê°œì„  ë°©ë²• (ë°˜ë“œì‹œ í¬í•¨)**:
                       - ê° ì›ì¸(A/B/C)ì— ëŒ€í•´ **êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ìˆ˜ë¦¬/ê°œì„  ë°©ë²•**ì„ ì œì‹œí•˜ì‹­ì‹œì˜¤:
                         (A) ê±°ì£¼ìŠµê´€ ê°œì„ : í™˜ê¸° íšŸìˆ˜/ì‹œê°„(ì˜ˆ: 1ì¼ 3íšŒ, 1íšŒ 10ë¶„ ì´ìƒ ë§í†µí’), ì œìŠµê¸° ìš©ëŸ‰ ë° ì„¤ì •ìŠµë„, ë¹¨ë˜ê±´ì¡° ë°©ë²• ë³€ê²½, ì¡°ë¦¬ ì‹œ ë ˆì¸ì§€í›„ë“œ ì‚¬ìš©ë²•, ê°€ìŠµê¸° ì ì • ì‚¬ìš©ëŸ‰ ë“± **êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ë°©ë²•** ì œì‹œ
                         (B) ë‹¨ì—´ ë³´ìˆ˜: ì—´êµ ë¶€ìœ„ë³„ ë³´ìˆ˜ ë°©ë²•(ë‹¨ì—´ì¬ ë§ëŒ, ê¸°ë°€í…Œì´í”„ ì‹œê³µ, ë‹¨ì—´ê°„ë´‰ êµì²´, ì°½í˜¸ ê¸°ë°€ë³´ê°• ë“±), ì˜ˆìƒ ë¹„ìš© ë²”ìœ„, ì‹œê³µ ìš°ì„ ìˆœìœ„
                         (C) ê¸°íƒ€ ìˆ˜ë¦¬: ì „ì—´êµí™˜ê¸° í•„í„° ì²­ì†Œ/ê°€ë™ë²•, ë°°ê´€ ëˆ„ìˆ˜ ì ê²€ ë°©ë²•, ìš•ì‹¤/ì£¼ë°© êµ­ì†Œí™˜ê¸° ê°œì„  ë“±`;
                } else if(!vapOver && !mixOver) {
                    vapMixDiagnosis = `
                    8. **[í•µì‹¬] ìˆ˜ì¦ê¸°ì••/ì ˆëŒ€ìŠµë„ ìƒì„¸ ì›ì¸ ë¶„ì„ (ë°˜ë“œì‹œ í¬í•¨)**:
                       - ì¸¡ì •ê°’: VAP ${vapVal}kPa (ê¸°ì¤€ 1.2kPa **ì´í•˜**), MIX ${mixVal}g/kg (ê¸°ì¤€ 7.3g/kg **ì´í•˜**)
                       - VAPê³¼ MIX ëª¨ë‘ ì •ìƒ ë²”ìœ„ì´ë¯€ë¡œ, **ì‹¤ë‚´ ìˆ˜ì¦ê¸°ëŸ‰ì€ ì ì • ìˆ˜ì¤€**ì…ë‹ˆë‹¤.
                       - ì´ ê²½ìš° ê²°ë¡œì˜ ì£¼ì›ì¸ì€ **ê±°ì£¼ìŠµê´€ë³´ë‹¤ëŠ” ë‹¨ì—´ ì„±ëŠ¥ ë¶€ì¡± ê°€ëŠ¥ì„±**ì´ AI ë¶„ì„ìƒ ë†’ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
                       - ë°˜ë“œì‹œ ì•„ë˜ë¥¼ **êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„**í•˜ì‹­ì‹œì˜¤:
                         (A) **ë‹¨ì—´ ì„±ëŠ¥ ë¶€ì¡± ê°€ëŠ¥ì„±** (AI ë¶„ì„ ì†Œê²¬): ë²½ì²´/ì°½í˜¸ì˜ ë‹¨ì—´ ì„±ëŠ¥ì´ í˜„í–‰ ê¸°ì¤€ ëŒ€ë¹„ ì¶©ë¶„í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë©°, ì´ë¡œ ì¸í•´ í‘œë©´ì˜¨ë„ê°€ ë…¸ì  ì´í•˜ë¡œ í•˜ë½í•˜ì—¬ ê²°ë¡œê°€ ë°œìƒí•˜ëŠ” ê²ƒìœ¼ë¡œ ì¶”ì •ë¨. TDRê°’(${tdrMsg})ìœ¼ë¡œ ì°¸ê³ .
                         (B) **ì—´êµ(Thermal Bridge) ë¶€ìœ„ ì¶”ì •** (AI ë¶„ì„ ì†Œê²¬): ê°„ë´‰, í”„ë ˆì„, ë²½ì²´ ì½”ë„ˆ, ìŠ¬ë˜ë¸Œ ì ‘í•©ë¶€ ë“± ì—´êµ ê°€ëŠ¥ ìœ„ì¹˜ ì§€ì 
                         (C) **ê¸°íƒ€ ì›ì¸** (AI ë¶„ì„ ì†Œê²¬): ê¸°ë°€ì„± ì €í•˜(ì™¸í’ ì¹¨íˆ¬ ê°€ëŠ¥ì„±), ì´ˆê¸° ê±´ì¶•ë¬¼ ìŠµê¸° ì”ì¡´ ê°€ëŠ¥ì„±
                    9. **[í•µì‹¬] ì›ì¸ë³„ ë§ì¶¤ ìˆ˜ë¦¬/ê°œì„  ë°©ë²• (ë°˜ë“œì‹œ í¬í•¨)**:
                       - **ë‹¨ì—´ ë³´ê°• ì¤‘ì‹¬**ìœ¼ë¡œ êµ¬ì²´ì  ê°œì„  ë°©ë²•ì„ ì œì‹œí•˜ì‹­ì‹œì˜¤:
                         (A) ì—´êµ ë¶€ìœ„ë³„ ë‹¨ì—´ ë³´ê°•: ì½”ë„ˆë¶€ ë‹¨ì—´ì¬ ë§ëŒ(ì´ë³´ë“œ/XPS), ê°„ë´‰ êµì²´(ì•Œë£¨ë¯¸ëŠ„â†’TPS/TGI), ì°½í˜¸ í”„ë ˆì„ ë‹¨ì—´ ë³´ê°•, ê¸°ë°€í…Œì´í”„/ìš°ë ˆíƒ„í¼ ì¶©ì§„
                         (B) ë‹¨ì—´ ì„±ëŠ¥ ê°œì„ : ì„±ëŠ¥ ë¯¸í¡ ì¶”ì • ë¶€ìœ„ì˜ ë³´ìˆ˜/ë³´ê°• ë°©ë²• ì œì‹œ (AI ë¶„ì„ ê¸°ë°˜ ê¶Œê³ ì‚¬í•­ì´ë©°, ì •ë°€ í˜„ì¥ ì¡°ì‚¬ í›„ í™•ì • í•„ìš”)
                         (C) ë³´ì¡° ì¡°ì¹˜: ì„œí˜ë ˆì´í„°ë¥¼ ì´ìš©í•œ ê³µê¸° ìˆœí™˜, ê²°ë¡œ ë°©ì§€ íˆí„° ì„¤ì¹˜ ë“±`;
                } else {
                    vapMixDiagnosis = `
                    8. **[í•µì‹¬] ìˆ˜ì¦ê¸°ì••/ì ˆëŒ€ìŠµë„ ìƒì„¸ ì›ì¸ ë¶„ì„ (ë°˜ë“œì‹œ í¬í•¨)**:
                       - ì¸¡ì •ê°’: VAP ${vapVal}kPa (ê¸°ì¤€ 1.2kPa ${vapOver ? '**ì´ˆê³¼**' : 'ì´í•˜'}), MIX ${mixVal}g/kg (ê¸°ì¤€ 7.3g/kg ${mixOver ? '**ì´ˆê³¼**' : 'ì´í•˜'})
                       - VAPê³¼ MIX ì¤‘ ì¼ë¶€ë§Œ ê¸°ì¤€ ì´ˆê³¼ì´ë¯€ë¡œ **ë³µí•© ì›ì¸**ì´ ì˜ì‹¬ë©ë‹ˆë‹¤.
                       - ë°˜ë“œì‹œ ì•„ë˜ 3ê°€ì§€ ì›ì¸ì„ **êµì°¨ ë¶„ì„**í•˜ì‹­ì‹œì˜¤:
                         (A) **ê±°ì£¼ìŠµê´€ + ë‹¨ì—´ ë³µí•© ì›ì¸**: ê²½ë¯¸í•œ ìˆ˜ì¤€ì˜ ìˆ˜ì¦ê¸° ê³¼ë‹¤ì™€ ë¶€ë¶„ì  ë‹¨ì—´ ë¶€ì¡±ì´ ë™ì‹œì— ì‘ìš©
                         (B) **êµ­ì†Œ í™˜ê¸° ë¶€ì¡±** (AI ë¶„ì„ ì†Œê²¬): íŠ¹ì • ê³µê°„(ìš•ì‹¤, ì£¼ë°©, ë“œë ˆìŠ¤ë£¸)ì˜ í™˜ê¸° ë¶€ì¡±ìœ¼ë¡œ êµ­ë¶€ì  ìŠµë„ ìƒìŠ¹
                         (C) **ê³„ì ˆì  ë³€ë™**: ì¸¡ì • ì‹œì ì˜ ì™¸ê¸° ì¡°ê±´ì— ë”°ë¥¸ ì¼ì‹œì  ë³€ë™ ê°€ëŠ¥ì„±
                       - TDRê°’(${tdrMsg})ê³¼ êµì°¨í•˜ì—¬ ì£¼ëœ ì›ì¸ ë¹„ìœ¨ì„ AI ì†Œê²¬ìœ¼ë¡œ ì œì‹œí•˜ì‹­ì‹œì˜¤.
                    9. **[í•µì‹¬] ì›ì¸ë³„ ë§ì¶¤ ìˆ˜ë¦¬/ê°œì„  ë°©ë²• (ë°˜ë“œì‹œ í¬í•¨)**:
                       - ë³µí•© ì›ì¸ì— ë§ëŠ” **ë³‘í–‰ ì¡°ì¹˜**ë¥¼ ì œì‹œí•˜ì‹­ì‹œì˜¤:
                         (A) ê±°ì£¼ìŠµê´€ ì¼ë¶€ ê°œì„ : í™˜ê¸° ë¹ˆë„ ì¦ê°€(1ì¼ 3íšŒ ì´ìƒ), ë¬¸ì œ ê³µê°„ ì§‘ì¤‘ í™˜ê¸°
                         (B) ë‹¨ì—´ ë¶€ë¶„ ë³´ê°•: ì—´êµ ë¶€ìœ„ ìš°ì„  ë³´ìˆ˜, ì°½í˜¸ ê¸°ë°€ ë³´ê°•
                         (C) í™˜ê¸° ì‹œìŠ¤í…œ: ì „ì—´êµí™˜ê¸° ê°€ë™, ìš•ì‹¤/ì£¼ë°© í™˜í’ê¸° ìƒì‹œ ê°€ë™, ì œìŠµê¸° í™œìš©`;
                }
            } else {
                airQualityLogic = "VAP/MIX ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ TDRê³¼ ì˜¨ìŠµë„ ìœ„ì£¼ë¡œ ë¶„ì„í•˜ì‹­ì‹œì˜¤.";
                vapMixDiagnosis = "";
            }

            let windowSpecifics = "";
            if(winType.includes("ì…ë©´ë¶„í• ")) {
                windowSpecifics = "- ì…ë©´ë¶„í• ì°½ íŠ¹ì„±: í•˜ë‹¨ë¶€ í†µë°”(Transom) ë° í”„ë ˆì„ ì ‘í•©ë¶€ì˜ ë‹¨ì—´ ì·¨ì•½ì„±ì„ ì§‘ì¤‘ ë¶„ì„í•˜ì‹­ì‹œì˜¤.";
            } else {
                windowSpecifics = `- **ë§¤ìš° ì¤‘ìš”**: ì‚¬ìš©ìê°€ ì„ íƒí•œ ì°½í˜¸ëŠ” '${winType}'ì…ë‹ˆë‹¤. ë¶„ì„ ì‹œ ë°˜ë“œì‹œ ì´ ì°½í˜¸ ì¢…ë¥˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‚¼ê³ , ì„ íƒí•˜ì§€ ì•Šì€ ë‹¤ë¥¸ ì°½í˜¸(ì˜ˆ: ì…ë©´ë¶„í• ì°½ ë“±)ì— ëŒ€í•œ ì–¸ê¸‰ì€ ì ˆëŒ€ í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.`;
            }

            const concreteLogic = "- ê±´ë¬¼ íŠ¹ì„±ìƒ ì½˜í¬ë¦¬íŠ¸ ë° ëª°íƒˆì˜ ì–‘ìƒ ê³¼ì •ì—ì„œ ë°©ì¶œë˜ëŠ” 'ì´ˆê¸° ê±´ì¶•ë¬¼ ìŠµê¸°(Construction Moisture)'ê°€ ê²°ë¡œì˜ ì›ì¸ì´ ë  ìˆ˜ ìˆìŒì„ ë°˜ë“œì‹œ ì–¸ê¸‰í•˜ì‹­ì‹œì˜¤. (íŠ¹íˆ ì…ì£¼ 2ë…„ ì´ë‚´ ì‹ ì¶•ì¸ ê²½ìš°)";

            try {
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });

                const dbContext = JSON.stringify(CONDENSATION_DB);
                
                const prompt = `
                    ë‹¹ì‹ ì€ 'ê±´ì¶•ë¬¼ë¦¬ ë°•ì‚¬'ì´ì 'ê²°ë¡œ ì§„ë‹¨ ìµœê³  ì „ë¬¸ê°€'ì…ë‹ˆë‹¤. 
                    ì œê³µëœ í˜„ì¥ ë°ì´í„°ì™€ [í‘œì¤€ ë°ì´í„°ë² ì´ìŠ¤]ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •ë°€ ì§„ë‹¨ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

                    [ì°¸ì¡° ë°ì´í„°ë² ì´ìŠ¤]
                    ${dbContext}

                    [í˜„ì¥ ë°ì´í„°]
                    - êµ¬ì¡°/ì°½í˜¸: ${winType} / ${houseType}
                    - **ê°„ë´‰ ì¢…ë¥˜**: ${consideration}
                    - ì‹¤ë‚´: ${tempIn}Â°C / ${humid}% (ë…¸ì : ${dew})
                    - ì‹¤ì™¸: ${tempOut}Â°C / í‘œë©´ì˜¨ë„: ${tempSurf}Â°C
                    - ê³µê¸°ì§ˆ(ì„ íƒ): VAP ${vapVal || 'N/A'}, MIX ${mixVal || 'N/A'}
                    - ì¦ìƒ: ${defect}
                    - **í•µì‹¬ TDR ë¶„ì„ê°’**: ${tdrMsg}

                    [íŠ¹ë³„ ì§€ì‹œì‚¬í•­ (ë°˜ë“œì‹œ ì¤€ìˆ˜)]
                    1. **ì°½í˜¸ ì¢…ë¥˜ ì—„ìˆ˜**: ${windowSpecifics}
                    2. **ê°„ë´‰ ë¶„ì„**: ${spacerLogic}
                    3. **ì°½í˜¸ ê¸°ë°€ì„±**: ${slidingLogic}
                    4. **ê³µê¸°ì§ˆ ë¶„ì„(ê²¨ìš¸ì²  ê¸°ì¤€ í¬í•¨)**: ${airQualityLogic}
                    5. **ì½˜í¬ë¦¬íŠ¸ íŠ¹ì„±**: ${concreteLogic}
                    6. **ë…¼ë¦¬ì  íŒì •**: 
                       - í‘œë©´ì˜¨ë„ê°€ ë…¸ì ì˜¨ë„ë³´ë‹¤ ë‚®ì€ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. (T_surf < T_dp ì´ë©´ ê²°ë¡œ ë°œìƒ)
                       - TDR 0.28 ê¸°ì¤€ì„ ì ìš©í•˜ë˜, VAP/MIX ê°’ì„ ì¢…í•©í•˜ì—¬ **ê²°ë¡œ ì›ì¸ ë¹„ìœ¨(í™˜ê¸° ë¶€ì¡± vs ë‹¨ì—´ ì„±ëŠ¥ ë¶€ì¡±)**ì„ AI ì†Œê²¬ìœ¼ë¡œ ì¶”ì •í•˜ì‹­ì‹œì˜¤.
                    7. **ê¸ˆì§€ì–´**: 'ê¸°ìˆ ì‚¬', 'í˜‘íšŒ', 'ì°½í˜¸ êµì²´ ê¶Œìœ ', 'ì‹œê³µ í•˜ì', 'ì‹œê³µ ë¶ˆëŸ‰', 'ì‹œê³µì‚¬ ê·€ì±…', 'í•˜ìë³´ìˆ˜ ì²­êµ¬', 'ë²•ì ', 'ì†Œì†¡' (êµì²´ ëŒ€ì‹  ë³´ìˆ˜/ê°œì„  ì œì•ˆ, ë‹¨ì •ì  íŒì • ëŒ€ì‹  AI ë¶„ì„ ì†Œê²¬ìœ¼ë¡œ í‘œí˜„)
                    â€» **ë§¤ìš° ì¤‘ìš”**: ëª¨ë“  ë¶„ì„ ê²°ê³¼ëŠ” ë°˜ë“œì‹œ 'AI ë¶„ì„ì— ì˜í•œ ì¶”ì • ì†Œê²¬'ì„ì„ ëª…ì‹œí•˜ì‹­ì‹œì˜¤. 'ì‹œê³µ í•˜ì', 'ì‹œê³µ ë¶ˆëŸ‰', 'ì‹œê³µì‚¬ ê·€ì±…' ë“± ë²•ì  ë¶„ìŸì„ ìœ ë°œí•  ìˆ˜ ìˆëŠ” í‘œí˜„ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ëŒ€ì‹  'ë‹¨ì—´ ì„±ëŠ¥ ê°œì„  í•„ìš” ë¶€ìœ„(AI ì¶”ì •)', 'ì„¤ê³„ ê¸°ì¤€ ëŒ€ë¹„ ì„±ëŠ¥ ë¯¸í¡ ê°€ëŠ¥ì„±(AI ë¶„ì„)', 'ì¶”ê°€ ì •ë°€ ì§„ë‹¨ ê¶Œê³ ' ë“±ì˜ ì¤‘ë¦½ì  í‘œí˜„ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
                    ${vapMixDiagnosis}

                    [ì¶œë ¥ í¬ë§·]
                    Markdown í˜•ì‹.
                    ## 1. ì •ë°€ ë°ì´í„° ë¶„ì„
                    (TDR, VAP/MIX, ë…¸ì , í‘œë©´ì˜¨ë„ ìƒí˜¸ ê´€ê³„ ì„¤ëª…)
                    ## 2. ìˆ˜ì¦ê¸°ì••(VAP)/ì ˆëŒ€ìŠµë„(MIX) ì›ì¸ íŒë³„ (AI ë¶„ì„)
                    (VAP/MIX ì¸¡ì •ê°’ì˜ ê¸°ì¤€ ì´ˆê³¼/ë¯¸ë‹¬ ì—¬ë¶€ë¥¼ ëª…ì‹œí•˜ê³ , ì´ê²ƒì´ ê±°ì£¼í™˜ê²½ ê´€ë¦¬ ë¬¸ì œì¸ì§€, ë‹¨ì—´ ì„±ëŠ¥ ê´€ë ¨ì¸ì§€, ê¸°íƒ€ ì›ì¸ì¸ì§€ AI ì†Œê²¬ìœ¼ë¡œ ë¶„ì„. VAP/MIX ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ ì„¹ì…˜ ìƒëµ)
                    ## 3. ì§„ë‹¨ ê²°ê³¼ ë° ë°œìƒ ë©”ì»¤ë‹ˆì¦˜ (AI ë¶„ì„)
                    (ë°ì´í„°ì— ê·¼ê±°í•œ ì›ì¸ ì¶”ì •, ê°„ë´‰/ë¯¸ì„œê¸°/ì½˜í¬ë¦¬íŠ¸ íŠ¹ì„± ë°˜ì˜. ëª¨ë“  íŒë‹¨ì€ AI ë¶„ì„ì— ì˜í•œ ì¶”ì •ì„ì„ ëª…ì‹œ)
                    ## 4. ì›ì¸ë³„ ë§ì¶¤ ê°œì„ /ë³´ìˆ˜ ë°©ë²• (AI ê¶Œê³ )
                    (ê±°ì£¼í™˜ê²½ ê°œì„ ë²•, ë‹¨ì—´ ë³´ê°• ë°©ë²•, ê¸°íƒ€ ê°œì„  ë°©ë²•ì„ ì›ì¸ë³„ë¡œ êµ¬ë¶„í•˜ì—¬ êµ¬ì²´ì  ìˆ˜ì¹˜/ë°©ë²•/ìš°ì„ ìˆœìœ„ì™€ í•¨ê»˜ ì œì‹œ. êµì²´ ê¶Œìœ  ì œì™¸. ì •ë°€ í˜„ì¥ ì¡°ì‚¬ í›„ í™•ì • í•„ìš”í•¨ì„ ì•ˆë‚´.)
                    ## 5. AI ì¢…í•© ì†Œê²¬
                    (AI ë°ì´í„° ë¶„ì„ ê¸°ë°˜ ì¢…í•© ì˜ê²¬, ê¸´ê¸‰ë„, í–¥í›„ ê´€ë¦¬ ë°©ì•ˆ ìš”ì•½. ë³¸ ì†Œê²¬ì€ AI ë¶„ì„ì— ì˜í•œ ì°¸ê³ ìë£Œì´ë©° ë²•ì  íš¨ë ¥ì´ ì—†ìŒì„ ë§ˆì§€ë§‰ì— ëª…ì‹œ.)

                    ë§ˆì§€ë§‰ì— ì•„ë˜ JSON í¬í•¨ (ì°¨íŠ¸ìš©):
                    ___JSON_START___
                    {"ventilation": ${tdrVal > 0.28 ? 20 : 80}, "insulation": ${tdrVal > 0.28 ? 80 : 20}, "normal": 0}
                    ___JSON_END___
                `;

                const result = await model.generateContent({ contents: [{ parts: [{ text: prompt }, ...imageParts] }] });
                const response = await result.response;
                let text = response.text();

                let jsonMatch = text.match(/___JSON_START___([\s\S]*?)___JSON_END___/);
                if(jsonMatch) {
                    const jsonData = JSON.parse(jsonMatch[1]);
                    drawChart(jsonData);
                    text = text.replace(jsonMatch[0], "");
                    chartSection.style.display = 'block';
                }

                const md = window.markdownit();
                contentDiv.innerHTML = md.render(text);
                loading.style.display = 'none';
                contentDiv.style.display = 'block';

                // â˜… ë¶„ì„ ì™„ë£Œ í›„ ìë™ PDF ì €ì¥
                autoSavePdf();

            } catch(e) {
                console.error('Analysis error:', e);
                loading.style.display = 'none';
                contentDiv.style.display = 'block';
                contentDiv.innerHTML = `<div style="color:#c62828; text-align:center; padding:30px; background:#ffebee; border-radius:10px; margin:20px 0;">
                    <i class="fas fa-exclamation-triangle" style="font-size:2rem; margin-bottom:10px;"></i>
                    <p style="font-weight:800; font-size:1.1rem;">AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
                    <p style="font-size:0.85rem; margin-top:10px;">ì˜¤ë¥˜ ë‚´ìš©: ${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
                    <p style="font-size:0.8rem; color:#666; margin-top:15px;">
                        â€¢ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”<br>
                        â€¢ ì‚¬ì§„ ìš©ëŸ‰ì´ ë„ˆë¬´ í¬ë©´ ì¤„ì—¬ì£¼ì„¸ìš”<br>
                        â€¢ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”
                    </p>
                </div>`;
            }
        };

        function drawChart(data) {
            var d = google.visualization.arrayToDataTable([
                ['ì›ì¸', 'ë¹„ìœ¨'],
                ['í™˜ê¸°/ê±°ì£¼í™˜ê²½ ê´€ë ¨ (AI ì¶”ì •)', data.ventilation],
                ['ë‹¨ì—´ ì„±ëŠ¥ ê´€ë ¨ (AI ì¶”ì •)', data.insulation],
                ['ê¸°íƒ€ ë³µí•© ìš”ì¸ (AI ì¶”ì •)', data.normal]
            ]);
            var options = {
                title: 'ê²°ë¡œ ì›ì¸ ë¹„ìœ¨ ë¶„ì„ (AI ë°ì´í„° ê¸°ë°˜ ì¶”ì •)',
                is3D: true,
                slices: { 0: { color: '#FFA726' }, 1: { color: '#EF5350', offset: 0.1 }, 2: { color: '#66BB6A' } },
                backgroundColor: 'transparent',
                chartArea: { left: 10, top: 20, width: '60%', height: '80%' },
                legend: { position: 'right', alignment: 'center', textStyle: { color: '#333', fontSize: 12 } }
            };
            var c = new google.visualization.PieChart(document.getElementById('chart_div'));
            c.draw(d, options);
        }
    </script>
</body>
</html>
